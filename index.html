<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Baghdatis Academy: Pixel Pathway</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #060a0f; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; touch-action: none; user-select: none; }
    #wrap { position: relative; transform-origin: center center; }
    canvas { display: block; image-rendering: pixelated; background: #000; }
    #hint { color: #2a3550; font-family: 'Courier New', monospace; font-size: 10px; text-align: center; margin-top: 5px; letter-spacing: 2px; }
  </style>
</head>
<body>
  <div id="wrap"><canvas id="game" width="512" height="384"></canvas></div>
  <div id="hint">ARROWS · Z=ACTION · X=SLICE · ESC=BACK | v2026.6</div>
  <script>
    'use strict';
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = 512, H = 384;

    function resizeGame() {
      const vw = window.innerWidth, vh = window.innerHeight;
      const scale = Math.min((vw - 20) / W, (vh - 44) / H);
      document.getElementById('wrap').style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame); resizeGame();

    // Assets
    const spr = new Image(); spr.src = 'marcos_sheet.png?v=2026';
    const oppSpr = new Image(); oppSpr.src = 'opponent_sheet_new.png?v=2026';
    const titleBg = new Image(); titleBg.src = 'title_bg_hd.png?v=2026';
    
    // NEW City & Intro Assets
    const cityBg = new Image(); cityBg.src = 'assets/city/city_background.png?v=2026';
    const gymBldg = new Image(); gymBldg.src = 'assets/city/gym_building.png?v=2026';
    const shopBldg = new Image(); shopBldg.src = 'assets/city/tek_shop_building.png?v=2026';
    const busSpr = new Image(); busSpr.src = 'assets/city/bus_sprite.png?v=2026';
    
    const storyImages = [new Image(), new Image(), new Image()];
    storyImages[0].src = 'assets/intro/intro_1_player.png?v=2026';
    storyImages[1].src = 'assets/intro/intro_2_svitolina.png?v=2026';
    storyImages[2].src = 'assets/intro/intro_3_wu.png?v=2026';

    const FRAMES = {
      idle: [0, 0], run1: [1, 0], run2: [2, 0], forehand: [3, 0], backhand: [4, 0],
      serveUp: [0, 1], serveHit: [1, 1], fist: [2, 1], dive: [3, 1], stand: [4, 1]
    };
    function drawSpr(name, x, y, w, h, flipX = false, sheet = spr) {
      const f = FRAMES[name] || FRAMES.stand;
      ctx.save();
      if (flipX) { ctx.translate(x + w, y); ctx.scale(-1, 1); ctx.drawImage(sheet, f[0]*128, f[1]*160, 128, 160, 0, 0, w, h); }
      else { ctx.drawImage(sheet, f[0]*128, f[1]*160, 128, 160, x, y, w, h); }
      ctx.restore();
    }

    const Keys = {}, JP = {};
    window.onkeydown=e=>{if(!Keys[e.code])JP[e.code]=true;Keys[e.code]=true;if(ga()&&ga().state==='suspended')ga().resume();};
    window.onkeyup=e=>Keys[e.code]=false;
    const clearInput=()=>{for(const k in JP)delete JP[k];};

    let AC=null;
    const ga=()=>(!AC&&(AC=new(window.AudioContext||window.webkitAudioContext)()),AC);
    function tone(f,t,d,v,l=0){const a=ga();if(!a)return;const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type=t;o.frequency.value=f;const n=a.currentTime+l;g.gain.setValueAtTime(v,n);g.gain.exponentialRampToValueAtTime(1e-4,n+d);o.start(n);o.stop(n+d+.05)}
    const sfx=n=>{for(let o=0;o<n.length;o+=2)tone(n[o], 'square',.1,.1,o/2*.05)};

    // State Machine
    let STATE=null,curMap=0,freezeT=0;
    const Stats={power:25,agility:25,stamina:25,level:1,xp:0,coins:50,gymDefeated:0};
    const Transition={active:!1,t:0,dur:.5,cb:null,start(t){this.active||(this.active=!0,this.t=0,this.cb=t)},update(t){!this.active||(this.t+=t,this.t>=this.dur/2&&this.cb&&(this.cb(),this.cb=null),this.t>=this.dur&&(this.active=!1))},draw(){if(!this.active)return;const t=this.t<.25?this.t/.25:1-(this.t-.25)/.25;ctx.fillStyle=`rgba(6,10,20,${Math.min(1,t)})`,ctx.fillRect(0,0,W,H)}};
    function go(t){STATE?.exit?.(),STATE=t,STATE?.enter?.()}
    function goTransition(t){Transition.start(()=>go(t))}

    const HomeState = {
      sel: 0,
      update() {
        if(JP.ArrowUp)this.sel=(this.sel-1+2)%2;
        if(JP.ArrowDown)this.sel=(this.sel+1)%2;
        if(JP.KeyZ||JP.Enter) goTransition(this.sel === 0 ? StoryIntroState : HubState);
      },
      draw() {
        ctx.fillStyle='#060a10';ctx.fillRect(0,0,W,H);
        ctx.textAlign='center';
        txt('BAGHDATIS ACADEMY', W/2, H/2 - 20, '#f0c040', 20);
        txt(this.sel===0?'> NEW GAME <':'  NEW GAME',W/2,H/2+40,'#fff',10);
        txt(this.sel===1?'> CONTINUE <':'  CONTINUE',W/2,H/2+65,'#fff',10);
        txt('v2026.7', W/2, H - 20, '#2a3550', 6);
      }
    };

    const StoryIntroState = {
      t: 0, done: false, loaded: 0,
      story: [
        { text: "A legend of the court, his passion unmatched." },
        { text: "After his final match, a new chapter began..." },
        { text: "Sharing wisdom with a new generation." }
      ],
      enter() {
        this.t = 0; this.done = false; this.loaded = 0;
        storyImages.forEach(img => { if(img.complete) this.loaded++; else img.onload=()=>this.loaded++; });
      },
      update(dt) {
        if(this.loaded<storyImages.length) return;
        if(this.done||Transition.active) return;
        this.t += dt;
        if(JP.KeyZ || JP.Enter || this.t > 12) { this.done = true; goTransition(HubState); }
      },
      draw() {
        ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);
        if(this.loaded<storyImages.length){txt(`Loading...`,W/2,H/2,'#555',8,'center');return;}
        const scene = Math.min(2, ~~(this.t/4));
        const sceneTime = this.t % 4;
        const alpha = sceneTime < .5 ? sceneTime/.5 : sceneTime > 3.5 ? 1-(sceneTime-3.5)/.5 : 1;
        ctx.globalAlpha = alpha;
        ctx.drawImage(storyImages[scene], 0, 0, W, H);
        ctx.globalAlpha = 1;
        px(0,H-60,W,60,'rgba(0,0,0,0.6)');
        txt(this.story[scene].text, W/2, H - 35, '#fff', 7, 'center');
      }
    };
    
    const HubState = {
        px: W/2, py: H*0.7,
        enter() {
            if(curMap === 0) { this.px = W / 2; this.py = H * 0.7; }
            else { this.px = 100; this.py = H * 0.7; }
        },
        update(dt) {
            if(Transition.active) return;
            let dx=0, dy=0;
            if(Keys.ArrowLeft) dx=-1; if(Keys.ArrowRight) dx=1;
            if(Keys.ArrowUp) dy=-1; if(Keys.ArrowDown) dy=1;
            if(dx||dy){const l=Math.sqrt(dx*dx+dy*dy);this.px+=dx/l*120*dt;this.py+=dy/l*120*dt;}
            const busX=curMap===0?210:400,busY=curMap===0?320:300;
            if(Math.sqrt((this.px-(busX+60))**2+(this.py-(busY+24))**2)<50&&JP.KeyZ){const next=curMap===0?1:0;Transition.start(()=>{curMap=next;go(HubState);});}
        },
        draw() {
            if (curMap === 1) {
                if (cityBg.complete) ctx.drawImage(cityBg, 0, 0, W, H);
                if (gymBldg.complete) ctx.drawImage(gymBldg, 150, 50, 200, 150);
                if (shopBldg.complete) ctx.drawImage(shopBldg, 20, 200, 120, 100);
            } else {
                ctx.fillStyle='#8cf';ctx.fillRect(0,0,W,H);
                txt('ACADEMY',W/2,H/2,'#fff',20,'center');
            }
            const busX=curMap===0?210:400,busY=curMap===0?320:300;
            if (busSpr.complete) ctx.drawImage(busSpr, busX, busY, 120, 60);
            px(this.px-10,this.py-20,20,30,'#f06');
        }
    };

    function txt(t,x,y,c,s,a='left'){ctx.fillStyle=c;ctx.font=s+'px "Press Start 2P"';ctx.textAlign=a;ctx.fillText(t,x,y)}
    function px(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(x,y,w,h)}

    let lastT = 0;
    function loop(ts) {
      const dt = Math.min((ts - lastT) / 1000, 0.05); lastT = ts;
      STATE?.update(dt); STATE?.draw();
      Transition.update(dt); Transition.draw();
      clearInput(); requestAnimationFrame(loop);
    }
    go(HomeState);
    requestAnimationFrame(loop);
  </script>
</body>
</html>